<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∏–Ω–æVISION | –£–º–Ω—ã–π –∫–∏–Ω–æ–∫—Ä–∏—Ç–∏–∫</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        /* ... (–≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
        
        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .auth-btn {
            padding: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: transform 0.2s ease;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
        }

        .auth-btn:active {
            transform: translateY(0);
        }

        .google-btn {
            background: #4285F4;
            color: white;
        }

        .google-btn:hover {
            background: #357ae8;
        }

        .anon-btn {
            background: var(--accent-primary);
            color: white;
        }

        .anon-btn:hover {
            background: var(--accent-secondary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- ... (–æ—Å—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... -->

    <!-- –û–∫–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
    <div class="auth-container" id="auth-container">
        <div class="auth-modal glass">
            <h2>üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏</h2>
            <p>–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∞—à–∞ –∫–∏–Ω–æ–∫–æ–ª–ª–µ–∫—Ü–∏—è –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö</p>
            <div class="auth-buttons">
                <button class="auth-btn anon-btn" id="anon-auth">
                    <i class="fas fa-user-clock"></i>–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
                </button>
            </div>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                üîí –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–Ω–æ–Ω–∏–º–Ω–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ
            </p>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAgpmENDau8Vs-IZglI1TLsuFwbAhga28k",
            authDomain: "films-e77cd.firebaseapp.com",
            projectId: "films-e77cd",
            storageBucket: "films-e77cd.firebasestorage.app",
            messagingSenderId: "813004407817",
            appId: "1:813004407817:web:2b783bf7ed3b849ee7e4d8"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ==================== –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ====================
        const CloudSync = {
            async saveFilmsToCloud(films, userId) {
                try {
                    await db.collection('users').doc(userId).set({
                        films: films,
                        lastUpdated: new Date().toISOString()
                    }, { merge: true });
                    this.showSyncStatus('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                    this.showSyncStatus('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
                }
            },

            async loadFilmsFromCloud(userId) {
                try {
                    const doc = await db.collection('users').doc(userId).get();
                    return doc.exists ? doc.data().films || [] : [];
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    return [];
                }
            },

            setupRealtimeSync(userId, callback) {
                return db.collection('users').doc(userId).onSnapshot((doc) => {
                    if (doc.exists) {
                        callback(doc.data().films || []);
                    }
                });
            },

            showSyncStatus(message) {
                const status = document.getElementById('sync-status');
                status.textContent = message;
                status.className = 'sync-status show';
                
                setTimeout(() => status.classList.remove('show'), 3000);
            }
        };

        const KinoVisionApp = (() => {
            const elements = {
                // ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã) ...
                authContainer: document.getElementById('auth-container'),
                anonAuth: document.getElementById('anon-auth'),
                userAvatar: document.getElementById('user-avatar'),
                syncStatus: document.getElementById('sync-status')
            };

            let currentUser = null;
            let unsubscribeSync = null;

            function init() {
                setupEventListeners();
                checkAuthState();
                setupNetworkListeners();
            }

            function setupEventListeners() {
                // –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                elements.anonAuth.addEventListener('click', signInAnonymously);
                
                // –ö–ª–∏–∫ –ø–æ –∞–≤–∞—Ç–∞—Ä—É
                elements.userAvatar.addEventListener('click', toggleUserMenu);
                
                // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏) ...
            }

            function setupNetworkListeners() {
                window.addEventListener('online', () => {
                    CloudSync.showSyncStatus('üåê –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    if (currentUser) syncFilmsToCloud();
                });

                window.addEventListener('offline', () => {
                    CloudSync.showSyncStatus('‚ö†Ô∏è –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                });
            }

            async function signInAnonymously() {
                try {
                    CloudSync.showSyncStatus('üîê –í—Ö–æ–¥...');
                    const result = await auth.signInAnonymously();
                    console.log('–ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω:', result.user.uid);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                    CloudSync.showSyncStatus('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                    
                    // Fallback: –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                    elements.authContainer.classList.add('hidden');
                    loadFromLocalStorage();
                    renderFilmList();
                }
            }

            function checkAuthState() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        elements.authContainer.classList.add('hidden');
                        updateUserAvatar();
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                        await loadUserData();
                        
                    } else {
                        currentUser = null;
                        elements.authContainer.classList.remove('hidden');
                        loadFromLocalStorage();
                        renderFilmList();
                    }
                });
            }

            async function loadUserData() {
                try {
                    // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞
                    const cloudFilms = await CloudSync.loadFilmsFromCloud(currentUser.uid);
                    
                    if (cloudFilms.length > 0) {
                        films = cloudFilms;
                        CloudSync.showSyncStatus('‚òÅÔ∏è –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞');
                    } else {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        loadFromLocalStorage();
                        if (films.length > 0) {
                            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ
                            await CloudSync.saveFilmsToCloud(films, currentUser.uid);
                        }
                    }
                    
                    saveToLocalStorage();
                    renderFilmList();
                    setupRealtimeSync();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                    loadFromLocalStorage();
                    renderFilmList();
                }
            }

            function setupRealtimeSync() {
                if (unsubscribeSync) unsubscribeSync();
                
                unsubscribeSync = CloudSync.setupRealtimeSync(currentUser.uid, (cloudFilms) => {
                    films = cloudFilms;
                    saveToLocalStorage();
                    renderFilmList();
                    CloudSync.showSyncStatus('üîÑ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                });
            }

            function updateUserAvatar() {
                if (currentUser) {
                    elements.userAvatar.innerHTML = '‚òÅÔ∏è';
                    elements.userAvatar.title = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –æ–±–ª–∞–∫–æ–º';
                }
            }

            function toggleUserMenu() {
                if (currentUser && confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?\n–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ.')) {
                    auth.signOut();
                    if (unsubscribeSync) unsubscribeSync();
                    elements.userAvatar.innerHTML = '<i class="fas fa-user"></i>';
                    elements.userAvatar.title = '–ü—Ä–æ—Ñ–∏–ª—å';
                }
            }

            async function syncFilmsToCloud() {
                if (currentUser) {
                    await CloudSync.saveFilmsToCloud(films, currentUser.uid);
                }
            }

            function saveToLocalStorage() {
                localStorage.setItem('filmRatings', JSON.stringify(films));
                if (currentUser) syncFilmsToCloud();
            }

            // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            function saveFilmRating() {
                // ... (–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏) ...
                saveToLocalStorage();
            }

            function deleteFilm(filmId) {
                // ... (–∫–æ–¥ —É–¥–∞–ª–µ–Ω–∏—è) ...
                saveToLocalStorage();
            }

            return {
                init,
                deleteFilmFromModal: (filmId) => {
                    if (confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏?')) {
                        films = films.filter(film => film.id !== filmId);
                        saveToLocalStorage();
                        renderFilmList();
                        closeModal();
                    }
                },
                showFilmDetails,
                closeSyncModal: () => {
                    document.getElementById('sync-modal').classList.add('hidden');
                }
            };
        })();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.KinoVisionApp = KinoVisionApp;

        document.addEventListener('DOMContentLoaded', () => KinoVisionApp.init());
    </script>
</body>
</html>
